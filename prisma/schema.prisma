// Menufique - Schéma Prisma
// Documentation: docs/database-schema.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER
// ============================================
model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  emailVerified        DateTime?
  passwordHash         String? // null si connexion Google uniquement
  name                 String?
  image                String?
  plan                 Plan      @default(FREE)
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  restaurant Restaurant?
  menus      Menu[]
  accounts   Account[] // Pour NextAuth (OAuth providers)
  sessions   Session[] // Pour NextAuth

  @@map("users")
}

enum Plan {
  FREE
  PRO
}

// ============================================
// NEXTAUTH — TABLES REQUISES
// ============================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// PASSWORD RESET TOKEN
// ============================================
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("password_reset_tokens")
}

// ============================================
// RESTAURANT
// ============================================
model Restaurant {
  id           String   @id @default(cuid())
  userId       String   @unique
  name         String
  address      String?
  phone        String?
  email        String?
  website      String?
  logoUrl      String? // URL vers S3/Supabase Storage
  openingHours Json? // JSON libre : { "lundi": "12h-14h, 19h-22h", ... }
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  menus Menu[]

  @@map("restaurants")
}

// ============================================
// MENU
// ============================================
model Menu {
  id           String   @id @default(cuid())
  userId       String
  restaurantId String
  name         String   @default("Mon menu")
  slug         String   @unique // URL-friendly, ex: "le-bistrot-du-coin"
  templateId   String   @default("classic")
  customColors Json? // { primary: "#FF6B35", background: "#FFF8F2", text: "#1A1A2E" }
  customFonts  Json? // { heading: "Playfair Display", body: "Inter" }
  isPublished  Boolean  @default(false)
  aiDesignHtml   String?  @db.Text // Template HTML/CSS généré par l'IA
  aiBackgroundUrl String?          // URL de l'image décorative DALL-E
  designPrompt   String?          // Prompt utilisé pour la génération
  pdfUrl            String? // URL du dernier PDF généré
  qrCodeUrl         String? // URL du QR code généré
  designSnapshots   Json    @default("[]") // [{ id, label, html, createdAt }] — max 10
  createdAt         DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  categories Category[]

  @@index([userId])
  @@index([slug])
  @@map("menus")
}

// ============================================
// CATEGORY (section du menu : Entrées, Plats, etc.)
// ============================================
model Category {
  id          String   @id @default(cuid())
  menuId      String
  name        String // ex: "Entrées", "Plats principaux", "Desserts"
  description String? // Description optionnelle de la catégorie
  sortOrder   Int      @default(0) // Ordre d'affichage (drag & drop)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)
  dishes Dish[]

  @@index([menuId])
  @@map("categories")
}

// ============================================
// DISH (plat individuel)
// ============================================
model Dish {
  id          String   @id @default(cuid())
  categoryId  String
  name        String // ex: "Tartare de saumon"
  description String? // ex: "Saumon frais, avocat, agrumes, sésame"
  price       Decimal  @db.Decimal(8, 2) // ex: 14.50
  allergens   String[] @default([]) // ex: ["poissons", "sesame"]
  imageUrl    String?  @db.Text // Photo du plat (base64 data URI)
  isAvailable Boolean  @default(true) // Pour masquer temporairement un plat
  sortOrder   Int      @default(0) // Ordre d'affichage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@map("dishes")
}
